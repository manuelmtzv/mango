{{ define "create_note_modal" }}
<div
  class="fixed inset-0 z-50 flex items-center justify-center p-4"
  id="create-note-modal"
  x-data="{
    selectedTags: [],
    tagInput: '',
    showSuggestions: false,
    availableTags: {{ .AvailableTags | toJSON }} || [],
    init() {
      if (!this.availableTags) this.availableTags = [];
      document.body.style.overflow = 'hidden';
      this.$nextTick(() => {
        Motion.animate(this.$refs.backdrop, { opacity: [0, 1] }, { duration: 0.2 });
        Motion.animate(this.$refs.panel, { opacity: [0, 1], scale: [0.9, 1], y: [20, 0] }, { duration: 0.2, easing: 'ease-in-out' });
      });
    },
    close() {
      document.body.style.overflow = '';
      Promise.all([
        Motion.animate(this.$refs.backdrop, { opacity: 0 }, { duration: 0.2 }).finished,
        Motion.animate(this.$refs.panel, { opacity: 0, scale: 0.95, y: 10 }, { duration: 0.2 }).finished
      ]).then(() => {
        document.getElementById('modal').innerHTML = '';
      });
    },
    get filteredTags() {
      if (!this.availableTags || !this.selectedTags) return [];
      if (!this.tagInput) return this.availableTags.filter(t => !this.selectedTags.find(s => s.id === t.id));
      return this.availableTags.filter(t => 
        t.name.toLowerCase().includes(this.tagInput.toLowerCase()) && 
        !this.selectedTags.find(s => s.id === t.id)
      );
    },
    addTag(tag) {
      if (!this.selectedTags.find(t => t.id === tag.id)) {
        this.selectedTags.push(tag);
      }
      this.tagInput = '';
      this.showSuggestions = false;
    },
    addNewTag() {
      if (this.tagInput.trim() && !this.selectedTags.find(t => t.name.toLowerCase() === this.tagInput.toLowerCase())) {
        this.selectedTags.push({ id: 'new-' + Date.now(), name: this.tagInput.trim(), isNew: true });
        this.tagInput = '';
      }
      this.showSuggestions = false;
    },
    removeTag(tag) {
      this.selectedTags = this.selectedTags.filter(t => t.id !== tag.id);
    },
    getTagsJson() {
      return JSON.stringify(this.selectedTags.map(t => t.name));
    }
  }"
  @keydown.escape.window="close()"
  @note-created.window="close()"
>
  <div
    x-ref="backdrop"
    class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0"
    @click="close()"
  ></div>

  <div
    x-ref="panel"
    class="relative bg-dark-900 border border-border rounded-xl shadow-2xl w-full max-w-lg overflow-hidden opacity-0"
  >
    <div class="flex justify-between items-center p-4 border-b border-border">
      <h3 class="font-serif text-xl font-bold text-foreground">{{t "notes.create_new"}}</h3>
      <button
        class="text-muted-foreground hover:text-foreground transition-colors"
        @click="close()"
      >
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>

    <form
      hx-post="/{{.Lang}}/notes"
      hx-target="#notes-grid"
      hx-swap="afterbegin"
      class="p-4 space-y-4"
      @submit="$el.querySelector('[name=tags]').value = getTagsJson()"
    >
      <input type="hidden" name="tags" value="[]" />
      
      <div>
        <label for="title" class="block text-sm font-medium text-muted-foreground mb-1">{{t "notes.title"}}</label>
        <input
          type="text"
          name="title"
          id="title"
          required
          class="w-full bg-dark-800 border border-border rounded-lg px-4 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50"
          placeholder="{{t "notes.title_placeholder"}}"
          autofocus
        />
      </div>

      <div>
        <label for="content" class="block text-sm font-medium text-muted-foreground mb-1">{{t "notes.content"}}</label>
        <textarea
          name="content"
          id="content"
          required
          rows="5"
          class="w-full bg-dark-800 border border-border rounded-lg px-4 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"
          placeholder="{{t "notes.content_placeholder"}}"
        ></textarea>
      </div>

      <div class="relative">
        <label class="block text-sm font-medium text-muted-foreground mb-1">{{t "notes.tags"}}</label>
        <div class="flex flex-wrap gap-2 mb-2" x-show="selectedTags.length > 0">
          <template x-for="tag in selectedTags" :key="tag.id">
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-primary/20 text-primary text-sm border border-primary/30">
              <span x-text="'#' + tag.name"></span>
              <button type="button" @click="removeTag(tag)" class="hover:text-primary/80">
                <i data-lucide="x" class="w-3 h-3"></i>
              </button>
            </span>
          </template>
        </div>
        <div class="relative">
          <input
            type="text"
            x-model="tagInput"
            @focus="showSuggestions = true"
            @blur="setTimeout(() => showSuggestions = false, 200)"
            @keydown.enter.prevent="tagInput && addNewTag()"
            class="w-full bg-dark-800 border border-border rounded-lg px-4 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50"
            placeholder="{{t "notes.tags_placeholder"}}"
          />
          <div
            x-show="showSuggestions && (filteredTags.length > 0 || tagInput)"
            x-cloak
            class="absolute z-10 w-full mt-1 bg-dark-800 border border-border rounded-lg shadow-lg max-h-40 overflow-y-auto"
          >
            <template x-for="tag in filteredTags" :key="tag.id">
              <button
                type="button"
                @mousedown.prevent="addTag(tag)"
                class="w-full px-4 py-2 text-left text-sm text-gray-300 hover:bg-dark-700 hover:text-white transition-colors"
              >
                <span x-text="'#' + tag.name"></span>
              </button>
            </template>
            <button
              x-show="tagInput && !availableTags.find(t => t.name.toLowerCase() === tagInput.toLowerCase())"
              type="button"
              @mousedown.prevent="addNewTag()"
              class="w-full px-4 py-2 text-left text-sm text-primary hover:bg-dark-700 transition-colors border-t border-border"
            >
              <span>{{t "notes.create_tag"}} "<span x-text="tagInput"></span>"</span>
            </button>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <button
          type="button"
          class="px-4 py-2 rounded-lg border border-border text-muted-foreground hover:text-foreground hover:bg-dark-800 transition-colors"
          @click="close()"
        >
          {{t "common.cancel"}}
        </button>
        <button
          type="submit"
          class="primary-button"
        >
          {{t "common.save"}}
        </button>
      </div>
    </form>
  </div>
</div>
{{ end }}

